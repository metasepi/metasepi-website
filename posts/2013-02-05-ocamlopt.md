---
title: (作成中) ocamloptの全体像
description: ocamloptのランタイムとコンパイルパイプラインを知らべてみたでゲソ!
tags: ocaml, internal
---

## 発端

[ocamloptを読むことになりました。 - Togetter](http://togetter.com/li/450580)

...Camlp4はこわいでゲソ...
逃げるしかないじゃなイカ。

## ランタイム

ocaml-4.00.1/asmrun/i386.S がスタート。
Debianパッケージをビルドした結果からオブジェクト関係を調べる。

~~~
$ pwd
/home/kiwamu/src/readPurelyFunctionalDataStructures/LazyEvaluation

(gdb) set backtrace past-main on
(gdb) bt
#0  0x0000000000443b26 in caml_main ()
#1  0x0000000000443e10 in main ()
#2  0x00007ffff75576ad in __libc_start_main (main=0x443e04 <main>, argc=1, ubp_av=0x7fffffffe0b8, init=<optimized out>, fini=<optimized out>, rtld_fini=<optimized out>, 
    stack_end=0x7fffffffe0a8) at libc-start.c:227
#3  0x000000000040f459 in _start ()
~~~

なので、たぶんcaml_mainが最初。のはず。

~~~
caml_main (startup.c)
=> caml_start_program (amd64.S)
   => camlSmall_stream_test__entry <= OCamlコードから生成
~~~

実際の初期化内容はちゃんと調査しないと。 xxxxxxxxxxxxxxx

## コンパイルパイプライン

たぶん ocaml-4.00.1/driver/optmain.ml の

~~~
Asmpackager.package_files ppf (List.rev !objfiles) target;
~~~

あたりから開始。
ocaml-4.00.1/asmcomp/asmgen.ml がアセンブラ生成の末端？

xxxx
